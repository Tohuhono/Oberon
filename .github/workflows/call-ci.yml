name: CI

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
      repository:
        required: true
        type: string
      ref:
        required: true
        type: string
      base:
        required: true
        type: string
    secrets:
      VERCEL_PROJECT_ID:
        required: true
      VERCEL_API_TOKEN:
        required: true
      VERCEL_ORG_ID:
        required: true
      VERCEL_PROTECTION_BYPASS:
        required: false
      TURSO_URL:
        required: false
      TURSO_TOKEN:
        required: false

jobs:
  changed-packages:
    name: Changed Packages
    uses: ./.github/workflows/call-changed-packages.yml
    with:
      repository: ${{ inputs.repository }}
      ref: ${{ inputs.ref }}
      base: ${{ inputs.base }}

  validate:
    name: Validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.repository }}
          ref: ${{ inputs.ref }}
      - name: Cache turbo build setup
        uses: actions/cache@v4
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-turbo-
      - name: Use pNpm
        uses: pnpm/action-setup@v4
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24.x"
          cache: "pnpm"
      - name: Install
        run: pnpm i
      - name: Install Playwright browsers
        run: pnpx playwright install --with-deps chromium
      - name: Prettier
        run: pnpm prettier
      - name: Check
        run: pnpm check

  deploy_docs:
    name: Oberon Docs
    needs: [changed-packages]
    if: ${{ contains(needs.changed-packages.outputs.changed_packages, '@oberon/docs') }}
    uses: ./.github/workflows/call-deploy.yml
    with:
      environment: ${{ inputs.environment }}
      repository: ${{ inputs.repository }}
      ref: ${{ inputs.ref }}
      project: oberon-docs
    secrets:
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_API_TOKEN: ${{ secrets.VERCEL_API_TOKEN }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

  deploy_playground:
    name: Oberon Playground
    needs: [changed-packages]
    if: ${{ contains(needs.changed-packages.outputs.changed_packages, '@oberon/playground') }}
    uses: ./.github/workflows/call-deploy.yml
    with:
      environment: ${{ inputs.environment }}
      repository: ${{ inputs.repository }}
      ref: ${{ inputs.ref }}
      project: playground
    secrets:
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_API_TOKEN: ${{ secrets.VERCEL_API_TOKEN }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
      TURSO_URL: ${{ secrets.TURSO_URL }}
      TURSO_TOKEN: ${{ secrets.TURSO_TOKEN }}

  smoke_docs:
    name: Smoke Test Docs
    needs: [changed-packages, deploy_docs]
    uses: ./.github/workflows/call-smoke.yml
    with:
      repository: ${{ inputs.repository }}
      ref: ${{ inputs.ref }}
      project: docs
      base_url: ${{ needs.deploy_docs.outputs.url }}
    secrets:
      VERCEL_PROTECTION_BYPASS: ${{ secrets.VERCEL_PROTECTION_BYPASS }}

  smoke_playground:
    name: Smoke Test Playground
    needs: [changed-packages, deploy_playground]
    uses: ./.github/workflows/call-smoke.yml
    with:
      repository: ${{ inputs.repository }}
      ref: ${{ inputs.ref }}
      project: playground
      base_url: ${{ needs.deploy_playground.outputs.url }}
    secrets:
      VERCEL_PROTECTION_BYPASS: ${{ secrets.VERCEL_PROTECTION_BYPASS }}

  test-status:
    name: Test Status
    needs: [changed-packages, validate, deploy_docs, deploy_playground, smoke_docs, smoke_playground]
    if: always() && !contains(needs.*.result, 'cancelled')
    runs-on: ubuntu-latest
    env:
      STATUS: "${{ contains(needs.*.result, 'failure') && 'failed' || 'passed' }}"
      MESSAGE: |
        Latest deployments available at: 
        ${{ needs.deploy_docs.outputs.url && format('[docs]({0}) ', needs.deploy_docs.outputs.url) }}
        ${{ needs.deploy_playground.outputs.url && format('[developer playground]({0}) ', needs.deploy_playground.outputs.url) }}
    steps:
      - name: Add preview URL to job summary
        run: |
          echo "${{ env.MESSAGE }}" >> $GITHUB_STEP_SUMMARY
      - name: Failing deploy
        if: ${{ env.STATUS == 'failed' }}
        run: exit 1

  promote_docs:
    name: Oberon CMS Docs
    needs: [validate, deploy_docs, smoke_docs]
    if: inputs.environment == 'production'
    uses: ./.github/workflows/call-promote.yml
    secrets:
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_API_TOKEN: ${{ secrets.VERCEL_API_TOKEN }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
    with:
      environment: ${{ inputs.environment }}
      project: oberon-docs
      staging_url: ${{ needs.deploy_docs.outputs.url }}
      production_url: www.oberoncms.com

  promote_playground:
    name: Oberon Playground
    needs: [validate, deploy_playground, smoke_playground]
    if: inputs.environment == 'production'
    uses: ./.github/workflows/call-promote.yml
    secrets:
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_API_TOKEN: ${{ secrets.VERCEL_API_TOKEN }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
    with:
      environment: ${{ inputs.environment }}
      project: playground
      staging_url: ${{ needs.deploy_playground.outputs.url }}
      production_url: playground.tohuhono.com

  smoke-docs-production:
    name: Smoke Test Promoted Docs
    needs: [promote_docs]
    if: inputs.environment == 'production'
    uses: ./.github/workflows/call-smoke.yml
    with:
      repository: ${{ inputs.repository }}
      ref: ${{ inputs.ref }}
      project: docs
      base_url: https://www.oberoncms.com

  smoke-playground-production:
    name: Smoke Test Promoted Playground
    needs: [promote_playground]
    if: inputs.environment == 'production'
    uses: ./.github/workflows/call-smoke.yml
    with:
      repository: ${{ inputs.repository }}
      ref: ${{ inputs.ref }}
      project: playground
      base_url: https://playground.tohuhono.com
